# Autonomous Implementation Architecture Plan
**Project:** Seven Fortunas (7F_github)
**Created:** 2026-02-17
**Status:** Planning → Implementation

---

## Executive Summary

Convert BMAD workflow logic to **Python Agent SDK architecture** for true autonomous implementation (zero permission prompts).

**Problem:** BMAD workflows via Claude Code CLI trigger 15-20 permission prompts per feature (defeats autonomy).

**Solution:** Use Claude Agent SDK (Python) to make direct API calls, bypassing Claude Code's permission system entirely.

**Proven Pattern:** Successfully used in `/home/ladmin/dev/GDF/airgap_signing_bmad/airgap-autonomous/`

---

## Architecture Comparison

### Current Approach (BMAD Workflow)
```
User: /bmad-bmm-run-autonomous-implementation
  ↓
Claude Code: Loads workflow steps
  ↓
Agent: Executes via Bash tool (15-20 calls/feature)
  ↓
System: Permission prompt for EACH Bash call ❌
  ↓
User: Must click "Yes" repeatedly
```

**Result:** Theoretically autonomous, practically requires constant approval.

---

### Target Approach (Python Agent SDK)
```
User: ./scripts/run-autonomous.sh [--single]
  ↓
Bash: Sets up environment (native - no prompts)
  ↓
Python: Launches agent.py via Claude Agent SDK
  ↓
Agent: Direct API calls to Claude (bypasses permission system)
  ↓
Loop: Runs unattended until complete or circuit breaker
  ↓
User: Walk away for hours ✅
```

**Result:** True autonomy - zero interaction after launch.

---

## File Structure

### Current State (BMAD Workflow)
```
/home/ladmin/dev/GDF/7F_github/
├── _bmad-output/bmb-creations/workflows/run-autonomous-implementation/
│   ├── workflow.md
│   ├── steps-c/ (23 step files)
│   ├── steps-e/ (4 edit mode steps)
│   ├── steps-v/ (1 validate step)
│   ├── data/
│   └── templates/
├── app_spec.txt (42 features) ✅
├── feature_list.json (generated by Session 1) ✅
├── claude-progress.txt (tracking) ✅
├── autonomous_build_log.md (detailed log) ✅
└── init.sh (environment check) ✅
```

---

### Target State (Python Agent)
```
/home/ladmin/dev/GDF/7F_github/
├── autonomous-implementation/         # Task-specific subdirectory ✨ NEW
│   ├── CLAUDE.md                      # Task-specific instructions
│   ├── agent.py                       # Core autonomous agent (Session 1 + 2+)
│   ├── client.py                      # Claude SDK client wrapper
│   ├── prompts.py                     # Prompt loading utilities
│   ├── prompts/
│   │   ├── initializer_prompt.md     # Session 1: Parse app_spec.txt → feature_list.json
│   │   └── coding_prompt.md          # Session 2+: Implement features
│   └── scripts/
│       └── run-autonomous.sh         # Unified launcher (--single flag for one session)
├── app_spec.txt                       # Input (already exists) ✅
├── feature_list.json                  # State tracking (already exists) ✅
├── claude-progress.txt                # Progress metadata ✅
├── autonomous_build_log.md            # Detailed log ✅
└── issues.log                         # Error logging

# Keep BMAD workflow for manual intervention
├── _bmad-output/bmb-creations/workflows/run-autonomous-implementation/
│   ├── steps-e/ (EDIT mode - manual feature/circuit breaker edits)
│   └── steps-v/ (VALIDATE mode - integrity checks)
```

**Note:** BMAD workflow's CREATE mode (autonomous implementation) → Python agent
**Keep:** BMAD EDIT and VALIDATE modes for manual intervention

---

## Implementation Plan

### Phase 1: Create Core Agent Files (2-3 hours)

#### Task 1.1: Create `agent.py`
**Source:** `/home/ladmin/dev/GDF/airgap_signing_bmad/airgap-autonomous/phase-4-integration/agent.py`

**Adaptations for 7F_github:**
- Remove airgap-specific logic (service launcher, Phase 2/3 checks)
- Use existing tracking files (feature_list.json, claude-progress.txt, autonomous_build_log.md)
- Implement circuit breakers:
  - `MAX_ITERATIONS = 10` (restart to prevent memory growth)
  - `MAX_CONSECUTIVE_SESSION_ERRORS = 5`
  - `MAX_STALL_SESSIONS = 5` (no progress detected)
- Exit code 42 for circuit breaker trigger (matches BMAD workflow)

**Key features:**
```python
# Two-mode system
if not feature_list.exists():
    prompt = get_initializer_prompt()  # Session 1
else:
    prompt = get_coding_prompt()        # Session 2+

# Progress tracking
passing = count_features_by_status(feature_list, "pass")
remaining = count_features_by_status(feature_list, "pending") +
            count_features_by_status(feature_list, "fail", max_attempts=3)

# Auto-loop with circuit breakers
while iteration < MAX_ITERATIONS and remaining > 0:
    # Run session, check progress, handle errors
```

---

#### Task 1.2: Create `client.py`
**Source:** `/home/ladmin/dev/GDF/airgap_signing_bmad/airgap-autonomous/phase-4-integration/client.py`

**Purpose:** Wrapper for Claude Agent SDK with model selection

**Minimal implementation:**
```python
from claude_agent_sdk import Client

DEFAULT_MODEL = "claude-sonnet-4-5-20250929"
MODEL_MAP = {
    "sonnet": "claude-sonnet-4-5-20250929",
    "opus": "claude-opus-4-6-20250902",
    "haiku": "claude-haiku-4-5-20251001"
}

def create_client(model: str = "sonnet") -> Client:
    return Client(model=MODEL_MAP.get(model, DEFAULT_MODEL))
```

---

#### Task 1.3: Create `prompts.py` and Prompt Templates

**prompts.py:**
```python
from pathlib import Path

PROMPTS_DIR = Path(__file__).parent / "prompts"
_project_dir = None

def set_project_dir(project_dir: Path):
    global _project_dir
    _project_dir = project_dir.resolve()

def load_prompt(name: str) -> str:
    content = (PROMPTS_DIR / f"{name}.md").read_text()

    # Inject project directory (critical for sandbox isolation)
    if _project_dir:
        content = f"""
## CRITICAL: PROJECT DIRECTORY
Your working directory: `{_project_dir}`

ALWAYS use absolute paths. Verify location before commands:
```bash
cd {_project_dir} && pwd && ls app_spec.txt
```
---

{content}
"""
    return content

def get_initializer_prompt() -> str:
    return load_prompt("initializer_prompt")

def get_coding_prompt() -> str:
    return load_prompt("coding_prompt")
```

---

**prompts/initializer_prompt.md:**
```markdown
# YOUR ROLE: INITIALIZER AGENT (Session 1)

You are setting up autonomous implementation for Seven Fortunas infrastructure.

## GOAL
Parse app_spec.txt and generate feature_list.json for autonomous implementation.

## SESSION CHECKLIST
1. Read CLAUDE.md for project context
2. Read app_spec.txt (42 features)
3. Generate feature_list.json from app_spec.txt
4. Initialize claude-progress.txt metadata
5. Create autonomous_build_log.md
6. Verify init.sh exists and is executable

## OUTPUT FORMAT: feature_list.json
```json
{
  "metadata": {
    "project_name": "7F_github - Seven Fortunas",
    "total_features": 42,
    "generated_date": "2026-02-17T..."
  },
  "features": [
    {
      "id": "FEATURE_001",
      "name": "FR-1.4: GitHub CLI Authentication Verification",
      "category": "Infrastructure & Foundation",
      "status": "pending",
      "attempts": 0,
      "dependencies": [],
      "verification_criteria": {
        "functional": "...",
        "technical": "...",
        "integration": "..."
      }
    }
  ]
}
```

## CRITICAL RULES
- Use Read tool before Write/Edit (always!)
- Use absolute paths: {project_dir}/feature_list.json
- DO NOT implement features (that's Session 2+)
- Commit after initialization: git add -A && git commit -m "chore: initialize autonomous implementation"

Begin by reading CLAUDE.md, then app_spec.txt.
```

---

**prompts/coding_prompt.md:**
```markdown
# YOUR ROLE: CODING AGENT (Session N of Many)

You are implementing Seven Fortunas infrastructure features autonomously.

## GOAL
Implement ALL features in feature_list.json with status="pending" or (status="fail" AND attempts<3).
DO NOT STOP until all features pass or circuit breaker triggers.

## SESSION CHECKLIST
1. Read CLAUDE.md for project context
2. Load feature_list.json to find next feature
3. Check claude-progress.txt for session state

## WORKFLOW PER FEATURE
1. **Select:** Find next feature (status="pending", no unsatisfied dependencies)
2. **Implement:** Create/modify code based on verification criteria
   - Use bounded retry: STANDARD (attempt 1) → SIMPLIFIED (attempt 2) → MINIMAL (attempt 3)
3. **Test:** Execute verification criteria (functional, technical, integration)
4. **Update Tracking:**
   - feature_list.json: status="pass"/"fail", attempts++, verification_results
   - claude-progress.txt: Update metadata (features_completed, last_updated)
   - autonomous_build_log.md: Append implementation log
5. **Commit:** git add -A && git commit -m "feat(FEATURE_XXX): description"
6. **Loop:** IMMEDIATELY continue to next feature (DO NOT stop to summarize)

## BOUNDED RETRY STRATEGY
- **Attempt 1 (STANDARD):** Full implementation (5-10 min)
- **Attempt 2 (SIMPLIFIED):** Core only, skip optional (3-5 min)
- **Attempt 3 (MINIMAL):** Bare essentials, placeholders OK (1-2 min)
- **Attempt 4+:** Mark blocked, move to next feature

## CRITICAL RULES
- Use Read before Write/Edit (always!)
- Use absolute paths: {project_dir}/feature_list.json
- Commit after EACH passing feature
- DO NOT stop for questions - make reasonable decisions
- DO NOT write summaries - keep implementing
- If stuck 3 times, mark blocked and move on

## FILE STRUCTURE
- Implementation files: scripts/, src/, tests/
- Tracking: feature_list.json, claude-progress.txt, autonomous_build_log.md

Begin by reading CLAUDE.md, then selecting next feature from feature_list.json.
```

---

### Phase 2: Create Launcher Script (1 hour)

#### Task 2.1: Create `scripts/run-autonomous.sh`

**Features:**
- Single unified script (not separate single/continuous)
- `--single` flag for one iteration only (debugging)
- `--model` flag for model selection (sonnet/opus/haiku)
- `--max-iterations` flag (default: 10, prevents memory growth)
- Pre-flight checks (git repo, app_spec.txt, venv)
- Automatic venv setup and dependency installation
- Progress display before launch
- Circuit breaker detection (exit code 42)

**Template:**
```bash
#!/bin/bash
# Seven Fortunas - Autonomous Implementation Launcher
# Usage:
#   ./scripts/run-autonomous.sh                    # Continuous (max 10 iterations)
#   ./scripts/run-autonomous.sh --single           # Single iteration (debug)
#   ./scripts/run-autonomous.sh --model opus       # Use different model
#   ./scripts/run-autonomous.sh --max-iterations 5 # Custom iteration limit

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"
VENV_PYTHON="$PROJECT_DIR/venv/bin/python"
AGENT_SCRIPT="$PROJECT_DIR/agent.py"

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

cd "$PROJECT_DIR"

# Pre-flight checks
echo "=== Pre-Flight Checks ==="

# 1. Git repository
if [ ! -d ".git" ]; then
    echo -e "${RED}ERROR: Not a git repository${NC}"
    exit 1
fi
echo "✓ Git repository"

# 2. app_spec.txt
if [ ! -f "app_spec.txt" ]; then
    echo -e "${RED}ERROR: app_spec.txt not found${NC}"
    exit 1
fi
echo "✓ app_spec.txt found"

# 3. Python venv
if [ ! -f "$VENV_PYTHON" ]; then
    echo "Creating Python virtual environment..."
    python3 -m venv venv
    ./venv/bin/pip install --upgrade pip
fi
echo "✓ Python venv"

# 4. Dependencies
if ! ./venv/bin/python -c "import claude_agent_sdk" 2>/dev/null; then
    echo "Installing claude-agent-sdk..."
    ./venv/bin/pip install claude-agent-sdk
fi
echo "✓ claude-agent-sdk installed"

# Display progress
if [ -f "feature_list.json" ]; then
    PASS=$(grep -o '"status": "pass"' feature_list.json | wc -l)
    PENDING=$(grep -o '"status": "pending"' feature_list.json | wc -l)
    FAIL=$(grep -o '"status": "fail"' feature_list.json | wc -l)
    echo ""
    echo "Current Progress: $PASS passing, $PENDING pending, $FAIL failed"
else
    echo ""
    echo "Fresh start - will initialize feature_list.json"
fi

echo ""
echo "=== Starting Autonomous Agent ==="
echo ""

# Run agent
./venv/bin/python agent.py "$@"
EXIT_CODE=$?

# Handle circuit breaker
if [ $EXIT_CODE -eq 42 ]; then
    echo ""
    echo -e "${YELLOW}======================================${NC}"
    echo -e "${YELLOW} CIRCUIT BREAKER TRIGGERED${NC}"
    echo -e "${YELLOW}======================================${NC}"
    echo ""
    echo "Review: autonomous_summary_report.md"
    echo ""
    echo "To reset and continue:"
    echo "  /bmad-bmm-run-autonomous-implementation --mode=edit"
    echo "  Select [C] Circuit Breaker → Reset consecutive_failures=0"
    echo ""
fi

exit $EXIT_CODE
```

---

### Phase 3: Testing & Validation (1 hour)

#### Task 3.1: Test Session 1 (Initializer)
```bash
# Remove existing tracking files (fresh start)
rm -f feature_list.json claude-progress.txt autonomous_build_log.md

# Run initializer (should generate feature_list.json)
./scripts/run-autonomous.sh --single --model sonnet

# Verify outputs
jq '.metadata.total_features' feature_list.json  # Should show: 42
grep -c '"status": "pending"' feature_list.json   # Should show: 42
```

---

#### Task 3.2: Test Session 2 (Single Feature)
```bash
# Run single iteration (implement FEATURE_001)
./scripts/run-autonomous.sh --single

# Verify progress
jq '.features[] | select(.id=="FEATURE_001") | .status' feature_list.json  # Should show: "pass"
git log -1 --oneline  # Should show feature commit
```

---

#### Task 3.3: Test Continuous Mode (3 Features)
```bash
# Run 3 iterations
./scripts/run-autonomous.sh --max-iterations 3

# Verify progress
PASS=$(grep -c '"status": "pass"' feature_list.json)
echo "Features completed: $PASS"  # Should show: 3 or more

# Check circuit breaker didn't trigger
echo $?  # Should NOT be 42
```

---

### Phase 4: Documentation (1 hour)

#### Task 4.1: Create Usage Guide
**File:** `AUTONOMOUS-IMPLEMENTATION-GUIDE.md`

**Contents:**
- Quick start guide
- Command reference (run-autonomous.sh flags)
- Troubleshooting circuit breaker triggers
- When to use BMAD EDIT mode vs agent
- Progress monitoring
- Stopping/resuming implementation

---

#### Task 4.2: Update CLAUDE.md
**Add reference to this plan document for post-compaction context recovery**

---

## When to Use What

### Use Python Agent (`./scripts/run-autonomous.sh`)
✅ **Autonomous implementation** - Unattended feature building
✅ **Bulk work** - Implementing 10+ features
✅ **Walk away scenarios** - Let it run for hours
✅ **Initial implementation** - First pass on all features

**Characteristics:**
- Zero user interaction after launch
- Runs outside Claude Code (no permission prompts)
- Circuit breakers prevent runaway loops
- Can be stopped/resumed safely

---

### Use BMAD Workflow (`/bmad-bmm-run-autonomous-implementation`)

#### EDIT Mode (`--mode=edit`)
✅ **Manual intervention** - Fix stuck features
✅ **Circuit breaker reset** - After 5 consecutive failures
✅ **State correction** - Fix corrupted tracking files
✅ **Feature management** - Mark features as blocked/pending

#### VALIDATE Mode (`--mode=validate`)
✅ **Integrity checks** - Verify tracking state
✅ **Progress reports** - Generate summary
✅ **Pre-deployment validation** - Final checks

#### CREATE Mode (DEPRECATED)
❌ **Don't use for autonomous implementation** - Too many permission prompts
→ **Use Python agent instead**

---

## Circuit Breakers

### In Python Agent (agent.py)

**MAX_ITERATIONS = 10**
- **Trigger:** After 10 consecutive feature attempts
- **Reason:** Prevent memory accumulation (restart clears context)
- **Action:** Exits with code 0, launcher restarts agent
- **Recovery:** Automatic (continuous mode) or manual restart

**MAX_CONSECUTIVE_SESSION_ERRORS = 5**
- **Trigger:** 5 sessions with exceptions/errors
- **Reason:** Something is fundamentally broken
- **Action:** Exits with code 1
- **Recovery:** Manual investigation required

**MAX_STALL_SESSIONS = 5**
- **Trigger:** No progress (passing count unchanged) for 5 sessions
- **Reason:** Agent is stuck, not making meaningful progress
- **Action:** Exits with code 0
- **Recovery:** Use BMAD EDIT mode to fix/unblock features

**Exit Code 42 (inherited from BMAD workflow concept)**
- **Trigger:** Fatal unrecoverable error
- **Action:** Exits with code 42, launcher displays circuit breaker message
- **Recovery:** Review autonomous_summary_report.md, use BMAD EDIT mode

---

## Progress Tracking Files

### feature_list.json
**Source of truth for implementation state**

```json
{
  "metadata": { "total_features": 42, ... },
  "features": [
    {
      "id": "FEATURE_001",
      "status": "pass",      // pending | in_progress | pass | fail | blocked
      "attempts": 1,
      "verification_results": {
        "functional": "pass",
        "technical": "pass",
        "integration": "pass"
      },
      "last_updated": "2026-02-17T17:30:00Z"
    }
  ]
}
```

---

### claude-progress.txt
**Hybrid format: Structured metadata + human-readable logs**

```
# Metadata (machine-readable)
session_count=2
features_completed=3
features_pending=39
circuit_breaker_status=HEALTHY
consecutive_failures=0
last_updated=2026-02-17T17:30:00Z

# Session Logs (human-readable, append-only)
## Session 1: Initializer (2026-02-17 16:00:00)
- Parsed app_spec.txt: 42 features extracted
- Generated feature_list.json
- Status: COMPLETE

## Session 2: Coding Agent (2026-02-17 17:00:00)
- FEATURE_001: PASS (GitHub CLI verification)
- FEATURE_002: PASS (Git repository check)
- FEATURE_003: FAIL (retry next session)
- Status: PROGRESS (3 features attempted, 2 passing)
```

---

### autonomous_build_log.md
**Detailed append-only log of all implementation actions**

```markdown
# Autonomous Implementation Build Log

**Project:** 7F_github
**Started:** 2026-02-17 16:00:00
**Total Features:** 42

---

## Session 1: Initializer (2026-02-17 16:00:00)

### Phase: Initialization
#### Actions Taken
1. Parsed app_spec.txt → 42 features
2. Generated feature_list.json
3. Initialized tracking files

---

## Session 2: Coding Agent (2026-02-17 17:00:00)

### FEATURE_001: GitHub CLI Authentication Verification
**Started:** 2026-02-17 17:05:00 | **Approach:** STANDARD (attempt 1)

#### Implementation Actions
1. Analyzed requirements
2. Created scripts/verify-gh-auth.sh
3. Implementation completed

#### Verification Testing
**Started:** 2026-02-17 17:08:00
1. Functional Test: PASS
2. Technical Test: PASS
3. Integration Test: PASS

#### Test Results Summary
**Overall:** pass | **Completed:** 2026-02-17 17:10:00

#### Git Commit
**Hash:** fcead7e
**Message:** feat(FEATURE_001): GitHub CLI Authentication Verification
```

---

## Dependencies

### Python Packages (requirements.txt)
```
claude-agent-sdk>=1.0.0
```

### System Requirements
- Python 3.8+
- Git
- GitHub CLI (gh) - authenticated
- jq (JSON processor)
- xmllint (optional, for app_spec.txt validation)

---

## Estimated Timeline

| Phase | Tasks | Duration |
|-------|-------|----------|
| 1. Core Agent Files | agent.py, client.py, prompts.py, 2 prompt templates | 2-3 hours |
| 2. Launcher Script | run-autonomous.sh with pre-flight checks | 1 hour |
| 3. Testing | Session 1 + 2 + continuous mode | 1 hour |
| 4. Documentation | Usage guide + CLAUDE.md updates | 1 hour |
| **Total** | | **5-6 hours** |

---

## Success Criteria

✅ **Functional:**
- [ ] `./scripts/run-autonomous.sh` runs without permission prompts
- [ ] Session 1 generates feature_list.json (42 features)
- [ ] Session 2+ implements features autonomously
- [ ] Can walk away for hours, returns to completed features
- [ ] Circuit breakers prevent infinite loops

✅ **Technical:**
- [ ] Tracking files correctly updated (feature_list.json, claude-progress.txt)
- [ ] Git commits created after each feature
- [ ] Exit code 42 on circuit breaker
- [ ] Logs provide debugging visibility (issues.log)

✅ **Operational:**
- [ ] Can stop (Ctrl+C) and resume safely
- [ ] BMAD EDIT mode can fix stuck states
- [ ] Progress monitoring via tracking files
- [ ] Documentation clear for future use

---

## Future Enhancements (Post-MVP)

1. **Web Dashboard:** Real-time progress visualization
2. **Slack/Email Notifications:** Alert on completion or circuit breaker
3. **Feature Prioritization:** Implement high-priority features first
4. **Parallel Execution:** Multiple features simultaneously (if independent)
5. **Rollback Capability:** Revert failed feature implementations
6. **Performance Metrics:** Track time per feature, success rates

---

## Appendix: Key Differences from airgap_signing_bmad

| Aspect | airgap_signing_bmad | 7F_github (this project) |
|--------|---------------------|--------------------------|
| **Feature tracking** | `feature_list.json` with `"passes": true/false` | Same, but with `status: "pass"/"fail"/"pending"/"blocked"` |
| **Service dependencies** | Phase 2 backend, Phase 3 frontend | None (pure infrastructure) |
| **Service launcher** | `service_launcher.py` start/stop/status | Not needed |
| **Testing framework** | pytest E2E tests | Verification criteria (functional/technical/integration) |
| **Archon integration** | Task tracking via MCP | Not used (optional future enhancement) |
| **Git strategy** | Parent repo at `/home/ladmin/dev/GDF/airgap_signing_bmad` | Current repo at `/home/ladmin/dev/GDF/7F_github` |
| **Bounded retry** | Not implemented | STANDARD → SIMPLIFIED → MINIMAL (3 attempts) |

---

**Document Version:** 1.0
**Last Updated:** 2026-02-17
**Status:** Ready for Implementation
