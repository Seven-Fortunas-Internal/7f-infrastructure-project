name: Quarterly Secret Detection Validation

on:
  schedule:
    # Run on first Monday of each quarter at 9 AM UTC
    # Q1: March, Q2: June, Q3: September, Q4: December
    - cron: '0 9 1 3,6,9,12 *'
  workflow_dispatch:
    # Allow manual trigger

jobs:
  validate-detection-rate:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run baseline test suite
        run: |
          cd tests/secret-detection
          ./test-suite.sh

      - name: Check detection rate
        run: |
          DETECTION_RATE=$(jq '.detection_rate' tests/secret-detection/test-results.json)
          echo "Detection Rate: $DETECTION_RATE%"

          if (( $(echo "$DETECTION_RATE >= 99.5" | bc -l) )); then
            echo "✓ PASS - Detection rate meets target"
          else
            echo "✗ FAIL - Detection rate below target"
            exit 1
          fi

      - name: Update security metrics
        run: |
          mkdir -p dashboards/security/data
          jq '{
            detection_rate: .detection_rate,
            false_negative_rate: .false_negative_rate,
            timestamp: .timestamp
          }' tests/secret-detection/test-results.json \
            > dashboards/security/data/detection-metrics-latest.json

      - name: Commit results
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add tests/secret-detection/test-results.json
          git add dashboards/security/data/detection-metrics-latest.json
          git diff --quiet && git diff --staged --quiet || \
            git commit -m "chore: Quarterly secret detection validation results [skip ci]"
          git push || true

      - name: Create summary
        run: |
          echo "## Quarterly Secret Detection Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Quarter:** Q$(( ($(date +%-m) - 1) / 3 + 1 )) $(date +%Y)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          jq -r '"**Detection Rate:** \(.detection_rate)%"' tests/secret-detection/test-results.json >> $GITHUB_STEP_SUMMARY
          jq -r '"**False Negative Rate:** \(.false_negative_rate)%"' tests/secret-detection/test-results.json >> $GITHUB_STEP_SUMMARY
          jq -r '"**Status:** \(.status)"' tests/secret-detection/test-results.json >> $GITHUB_STEP_SUMMARY
