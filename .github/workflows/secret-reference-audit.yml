name: Secret Reference Audit (FR-10.2)

# FR-10.2: Audits workflow files for undefined secret references.
# Blocks merge when secrets.XXX is used but not configured in the repository.
# Planned secrets (in .secrets-manifest.yml) are warnings, not errors.

on:
  pull_request:
    paths:
      - '.github/workflows/**'
      - '.secrets-manifest.yml'
      - 'scripts/audit-secret-references.sh'
    types: [opened, synchronize, reopened]

concurrency:
  group: secret-reference-audit-${{ github.ref }}
  cancel-in-progress: true

jobs:
  secret-audit:
    name: Secret Reference Audit
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
      pull-requests: write
      # secrets: read is not a real permission — gh CLI uses GITHUB_TOKEN

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Make audit script executable
        run: chmod +x scripts/audit-secret-references.sh

      - name: Run secret reference audit
        id: audit
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          set +e
          OUTPUT=$(./scripts/audit-secret-references.sh .github/workflows/ --repo "$GITHUB_REPOSITORY" 2>&1)
          RC=$?
          echo "$OUTPUT"
          echo "audit_output<<EOF" >> "$GITHUB_OUTPUT"
          echo "$OUTPUT" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"
          echo "exit_code=$RC" >> "$GITHUB_OUTPUT"
          exit $RC

      - name: Post PR comment on failure
        if: failure() && github.event_name == 'pull_request'
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const auditOut = `${{ steps.audit.outputs.audit_output }}`;
            const body = [
              '## ❌ Secret Reference Audit Failed (FR-10.2)',
              '',
              'This PR references secrets that are not configured in this repository.',
              'Either configure the secret or add it to `.secrets-manifest.yml` as "planned".',
              '',
              '<details><summary>Audit output</summary>\n\n```\n' + auditOut + '\n```\n</details>',
            ].join('\n');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });
