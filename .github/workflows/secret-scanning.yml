name: Secret Scanning

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  detect-secrets:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install detect-secrets
        run: pip install detect-secrets

      - name: Scan for secrets
        run: |
          detect-secrets scan --all-files --force-use-all-plugins \
            --exclude-files 'package-lock.json|yarn.lock|poetry.lock|venv/.*|tests/secret-detection/.*|\.secrets\.baseline.*|\.git/.*' \
            > .secrets.baseline.tmp

      - name: Fail if new secrets detected
        run: |
          # Compare scan against committed baseline — only fail on NEW secrets not previously known
          NEW_COUNT=$(python3 -c "
          import json
          new = json.load(open('.secrets.baseline.tmp'))
          old = json.load(open('.secrets.baseline')) if __import__('os').path.exists('.secrets.baseline') else {'results': {}}
          old_hashes = {f['hashed_secret'] for findings in old.get('results', {}).values() for f in findings}
          new_secrets = [(fname, f) for fname, findings in new.get('results', {}).items() for f in findings if f['hashed_secret'] not in old_hashes]
          if new_secrets:
              for fname, f in new_secrets:
                  print(f'  {fname}:{f[\"line_number\"]} [{f[\"type\"]}]')
          print(len(new_secrets))
          ")
          COUNT=$(echo "$NEW_COUNT" | tail -1)
          DETAILS=$(echo "$NEW_COUNT" | head -n -1)
          if [ "$COUNT" -gt "0" ]; then
            echo "⚠️ $COUNT NEW secret(s) detected (not in baseline):"
            echo "$DETAILS"
            exit 1
          else
            echo "✅ No new secrets detected"
          fi
