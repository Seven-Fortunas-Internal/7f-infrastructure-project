name: Monitor Dependency Resilience

on:
  schedule:
    # Check dependency health every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  check-resilience:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Analyze circuit breaker trips
        run: |
          mkdir -p compliance/resilience

          # Check for circuit breaker trips in last 24 hours
          if [ -f "compliance/resilience/circuit-breaker-trips.log" ]; then
            CUTOFF_TIME=$(date -u -d '24 hours ago' +%Y-%m-%dT%H:%M:%S)

            # Count recent trips
            RECENT_TRIPS=$(awk -v cutoff="$CUTOFF_TIME" '$1 > cutoff' \
              compliance/resilience/circuit-breaker-trips.log | wc -l)

            if [ "$RECENT_TRIPS" -gt 0 ]; then
              echo "⚠️ Found $RECENT_TRIPS circuit breaker trips in last 24 hours"
              echo "$RECENT_TRIPS" > /tmp/recent_trips.txt

              # Extract unique circuit breakers
              awk -v cutoff="$CUTOFF_TIME" '$1 > cutoff' \
                compliance/resilience/circuit-breaker-trips.log | \
                grep -oP "Circuit breaker '\K[^']*" | sort -u > /tmp/affected_circuits.txt
            else
              echo "✅ No circuit breaker trips in last 24 hours"
            fi
          else
            echo "ℹ️ No circuit breaker trip log found"
          fi

      - name: Analyze retry errors
        run: |
          if [ -f "compliance/resilience/retry-errors.log" ]; then
            CUTOFF_TIME=$(date -u -d '24 hours ago' +%Y-%m-%dT%H:%M:%S)

            # Count recent retry errors
            RECENT_ERRORS=$(awk -v cutoff="$CUTOFF_TIME" '$1 > cutoff' \
              compliance/resilience/retry-errors.log | wc -l)

            if [ "$RECENT_ERRORS" -gt 0 ]; then
              echo "⚠️ Found $RECENT_ERRORS retry errors in last 24 hours"

              # Count by function
              awk -v cutoff="$CUTOFF_TIME" '$1 > cutoff' \
                compliance/resilience/retry-errors.log | \
                grep -oP "Function: \K[^ ]*" | sort | uniq -c | sort -rn > /tmp/errors_by_function.txt

              cat /tmp/errors_by_function.txt
            else
              echo "✅ No retry errors in last 24 hours"
            fi
          else
            echo "ℹ️ No retry error log found"
          fi

      - name: Create alert for circuit breaker trips
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -f "/tmp/recent_trips.txt" ]; then
            TRIP_COUNT=$(cat /tmp/recent_trips.txt)
            AFFECTED=$(cat /tmp/affected_circuits.txt | tr '\n' ',' | sed 's/,$//')

            # Check for existing issue
            EXISTING_ISSUE=$(gh issue list \
              --label "resilience,NFR-6.2" \
              --state open \
              --search "Dependency Resilience Alert" \
              --json number \
              --jq '.[0].number')

            if [ -z "$EXISTING_ISSUE" ]; then
              # Create new issue
              printf '%s\n' \
                "## Circuit Breaker Trips Detected" "" \
                "**Count:** ${TRIP_COUNT} trips in last 24 hours" \
                "**Affected Circuit Breakers:** ${AFFECTED}" \
                "**Detection Time:** $(date -u +%Y-%m-%dT%H:%M:%SZ)" "" \
                "### Action Required" \
                "Review dependency failures and investigate root cause:" \
                "- See: compliance/resilience/circuit-breaker-trips.log" \
                "- See: compliance/resilience/retry-errors.log" \
                "- Verify external service status" \
                "- Implement additional error handling if needed" "" \
                "### NFR-6.2 Requirement" \
                "System SHALL implement retry logic and error logging for external dependencies." "" \
                "---" \
                "*Auto-generated by Dependency Resilience Monitor*" \
                > /tmp/issue_body.md
              gh issue create \
                --title "Dependency Resilience Alert: Circuit Breaker Trips" \
                --label "resilience,NFR-6.2,P1" \
                --body-file /tmp/issue_body.md
            else
              # Update existing issue
              printf '%s\n' \
                "New circuit breaker trips detected" "" \
                "**Count:** ${TRIP_COUNT} trips in last 24 hours" \
                "**Affected:** ${AFFECTED}" \
                "**Timestamp:** $(date -u +%Y-%m-%dT%H:%M:%SZ)" "" \
                "Dependency resilience issues persist. Investigation required." \
                > /tmp/comment_body.md
              gh issue comment "$EXISTING_ISSUE" \
                --body-file /tmp/comment_body.md
            fi
          fi

      - name: Generate resilience report
        run: |
          mkdir -p compliance/resilience/reports

          REPORT_DATE=$(date -u +%Y-%m-%d)
          REPORT_FILE="compliance/resilience/reports/resilience-report-${REPORT_DATE}.md"

          cat > "$REPORT_FILE" << 'EOFR'
          # Dependency Resilience Report (NFR-6.2)

          **Date:** $(date -u +%Y-%m-%d)
          **Generated:** $(date -u +%Y-%m-%dT%H:%M:%SZ)

          ## Summary

          EOFR

          # Add circuit breaker status
          if [ -f "compliance/resilience/circuit-breaker-trips.log" ]; then
            TOTAL_TRIPS=$(wc -l < compliance/resilience/circuit-breaker-trips.log)
            echo "**Total Circuit Breaker Trips (All Time):** $TOTAL_TRIPS" >> "$REPORT_FILE"
          else
            echo "**Total Circuit Breaker Trips:** 0" >> "$REPORT_FILE"
          fi

          # Add retry error status
          if [ -f "compliance/resilience/retry-errors.log" ]; then
            TOTAL_ERRORS=$(wc -l < compliance/resilience/retry-errors.log)
            echo "**Total Retry Errors (All Time):** $TOTAL_ERRORS" >> "$REPORT_FILE"
          else
            echo "**Total Retry Errors:** 0" >> "$REPORT_FILE"
          fi

          echo "" >> "$REPORT_FILE"
          echo "## Configuration" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          echo "- **Retry Strategy:** Exponential backoff (1s, 2s, 4s, 8s)" >> "$REPORT_FILE"
          echo "- **Max Retries:** 5" >> "$REPORT_FILE"
          echo "- **Circuit Breaker Threshold:** 5 consecutive failures" >> "$REPORT_FILE"
          echo "- **Recovery Timeout:** 60 seconds" >> "$REPORT_FILE"

          echo "Resilience report generated: $REPORT_FILE"

      - name: Commit reports
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add compliance/resilience/
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore(resilience): Update dependency resilience reports - $(date -u +%Y-%m-%dT%H:%M:%SZ)"
            git push
          fi
