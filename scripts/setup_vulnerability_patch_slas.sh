#!/bin/bash
# FEATURE_035: Vulnerability Patch SLAs
# Implements automated patching workflow with SLA tracking

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

echo "=== FEATURE_035: Vulnerability Patch SLAs Setup ==="
echo ""

# Verify GitHub authentication
echo "1. Verifying GitHub authentication..."
if ! gh auth status &>/dev/null; then
    echo "ERROR: GitHub CLI not authenticated. Run: gh auth login"
    exit 1
fi
echo "âœ“ GitHub authenticated"
echo ""

# Create SLA tracking configuration
echo "2. Creating SLA tracking configuration..."
mkdir -p "$PROJECT_ROOT/compliance/sla"

cat > "$PROJECT_ROOT/compliance/sla/vulnerability-patch-slas.yaml" << 'EOF'
# Vulnerability Patch SLAs
# Seven Fortunas Internal Security Policy

sla_policy:
  critical:
    name: Critical Vulnerabilities
    description: Critical severity vulnerabilities requiring immediate attention
    patch_window_hours: 24
    patch_window_days: 1
    severity_threshold: "critical"
    auto_merge: false  # Manual review required for critical patches
    alert_channels:
      - email
      - matrix
      - github_issue

  high:
    name: High Vulnerabilities
    description: High severity vulnerabilities with significant security impact
    patch_window_hours: 168
    patch_window_days: 7
    severity_threshold: "high"
    auto_merge: true  # Auto-merge if tests pass
    alert_channels:
      - email
      - matrix

  medium:
    name: Medium Vulnerabilities
    description: Medium severity vulnerabilities with moderate security impact
    patch_window_hours: 720
    patch_window_days: 30
    severity_threshold: "medium"
    auto_merge: true
    alert_channels:
      - github_issue

  low:
    name: Low Vulnerabilities
    description: Low severity vulnerabilities with minimal security impact
    patch_window_hours: 2160
    patch_window_days: 90
    severity_threshold: "low"
    auto_merge: true
    alert_channels: []

audit:
  frequency: monthly
  owner: Jorge
  report_location: compliance/sla/audit-reports/
  soc2_integration: true

metrics:
  - sla_compliance_rate
  - average_patch_time_by_severity
  - sla_breaches_count
  - auto_merge_success_rate
  - manual_intervention_rate

notifications:
  sla_breach_warning:
    enabled: true
    warning_threshold: 0.8  # Alert at 80% of SLA window
  monthly_audit:
    enabled: true
    recipients:
      - jorge@sevenfortunas.com
EOF

echo "âœ“ SLA configuration created: compliance/sla/vulnerability-patch-slas.yaml"
echo ""

# Create Dependabot auto-merge workflow
echo "3. Creating Dependabot auto-merge workflow..."
mkdir -p "$PROJECT_ROOT/.github/workflows"

cat > "$PROJECT_ROOT/.github/workflows/dependabot-auto-merge.yml" << 'EOF'
name: Dependabot Auto-Merge (SLA Compliance)

on:
  pull_request:
    branches: [main, master]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'

    steps:
      - name: Fetch PR metadata
        id: metadata
        uses: dependabot/fetch-metadata@v1
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"

      - name: Check severity and SLA
        id: sla_check
        run: |
          SEVERITY="${{ steps.metadata.outputs.severity }}"
          echo "Vulnerability severity: $SEVERITY"

          # SLA windows (in hours)
          case "$SEVERITY" in
            critical)
              SLA_HOURS=24
              AUTO_MERGE="false"  # Manual review required
              ;;
            high)
              SLA_HOURS=168  # 7 days
              AUTO_MERGE="true"
              ;;
            medium)
              SLA_HOURS=720  # 30 days
              AUTO_MERGE="true"
              ;;
            low)
              SLA_HOURS=2160  # 90 days
              AUTO_MERGE="true"
              ;;
            *)
              SLA_HOURS=2160
              AUTO_MERGE="true"
              ;;
          esac

          echo "sla_hours=$SLA_HOURS" >> $GITHUB_OUTPUT
          echo "auto_merge=$AUTO_MERGE" >> $GITHUB_OUTPUT

          # Check if PR is within SLA window
          PR_CREATED=$(gh pr view ${{ github.event.pull_request.number }} --json createdAt -q .createdAt)
          PR_AGE_HOURS=$(( ($(date +%s) - $(date -d "$PR_CREATED" +%s)) / 3600 ))

          echo "PR age: $PR_AGE_HOURS hours"
          echo "SLA window: $SLA_HOURS hours"

          if [ $PR_AGE_HOURS -gt $(( SLA_HOURS * 80 / 100 )) ]; then
            echo "âš ï¸ WARNING: Approaching SLA breach (80% of window)"
            echo "approaching_breach=true" >> $GITHUB_OUTPUT
          else
            echo "approaching_breach=false" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Wait for CI checks
        if: steps.sla_check.outputs.auto_merge == 'true'
        run: |
          echo "Waiting for CI checks to complete..."
          gh pr checks ${{ github.event.pull_request.number }} --watch --interval 30
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Auto-merge PR (if eligible)
        if: steps.sla_check.outputs.auto_merge == 'true'
        run: |
          echo "Auto-merging Dependabot PR (SLA compliance)..."
          gh pr merge ${{ github.event.pull_request.number }} --auto --squash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Alert for manual review (critical severity)
        if: steps.sla_check.outputs.auto_merge == 'false'
        run: |
          echo "âš ï¸ CRITICAL vulnerability detected - Manual review required"
          echo "SLA window: 24 hours"

          # Add comment to PR
          gh pr comment ${{ github.event.pull_request.number }} --body "ðŸš¨ **CRITICAL Vulnerability** - Manual review required within **24 hours** (SLA compliance)

          **Severity:** ${{ steps.metadata.outputs.severity }}
          **SLA Window:** 24 hours
          **Action Required:** Review and merge this PR within 24 hours to maintain SLA compliance.

          See \`compliance/sla/vulnerability-patch-slas.yaml\` for SLA policy."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Alert for SLA breach warning
        if: steps.sla_check.outputs.approaching_breach == 'true'
        run: |
          echo "âš ï¸ WARNING: Approaching SLA breach"

          gh pr comment ${{ github.event.pull_request.number }} --body "âš ï¸ **SLA Breach Warning** - This vulnerability PR is approaching the SLA window (80% elapsed).

          **Severity:** ${{ steps.metadata.outputs.severity }}
          **SLA Window:** ${{ steps.sla_check.outputs.sla_hours }} hours
          **Action:** Merge this PR to maintain SLA compliance."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
EOF

echo "âœ“ Auto-merge workflow created: .github/workflows/dependabot-auto-merge.yml"
echo ""

# Create monthly audit script
echo "4. Creating monthly SLA audit script..."
mkdir -p "$PROJECT_ROOT/compliance/sla/audit-reports"

cat > "$PROJECT_ROOT/scripts/monthly-vulnerability-sla-audit.sh" << 'EOF'
#!/bin/bash
# Monthly Vulnerability Patch SLA Audit
# Validates SLA compliance and generates report for SOC 2

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
TIMESTAMP=$(date +%Y%m%d-%H%M%S)
AUDIT_REPORT="$PROJECT_ROOT/compliance/sla/audit-reports/vulnerability-sla-audit-$TIMESTAMP.json"

echo "=== Monthly Vulnerability Patch SLA Audit ==="
echo "Date: $(date)"
echo "Report: $AUDIT_REPORT"
echo ""

# Load SLA policy
SLA_CONFIG="$PROJECT_ROOT/compliance/sla/vulnerability-patch-slas.yaml"
if [[ ! -f "$SLA_CONFIG" ]]; then
    echo "ERROR: SLA configuration not found: $SLA_CONFIG"
    exit 1
fi

echo "1. Fetching Dependabot alerts from all repositories..."

# Repositories to audit
REPOS=(
    "Seven-Fortunas-Internal/7f-infrastructure-project"
    "Seven-Fortunas-Internal/seven-fortunas-brain"
    "Seven-Fortunas/dashboards"
)

TOTAL_ALERTS=0
CRITICAL_ALERTS=0
HIGH_ALERTS=0
MEDIUM_ALERTS=0
LOW_ALERTS=0
SLA_BREACHES=0
PATCHED_WITHIN_SLA=0

for REPO in "${REPOS[@]}"; do
    echo "  Checking: $REPO"

    # Get open Dependabot alerts
    ALERTS=$(gh api "repos/$REPO/dependabot/alerts?state=open" --jq '.' 2>/dev/null || echo "[]")

    # Count by severity
    CRITICAL=$(echo "$ALERTS" | jq '[.[] | select(.security_advisory.severity == "critical")] | length')
    HIGH=$(echo "$ALERTS" | jq '[.[] | select(.security_advisory.severity == "high")] | length')
    MEDIUM=$(echo "$ALERTS" | jq '[.[] | select(.security_advisory.severity == "medium")] | length')
    LOW=$(echo "$ALERTS" | jq '[.[] | select(.security_advisory.severity == "low")] | length')

    CRITICAL_ALERTS=$((CRITICAL_ALERTS + CRITICAL))
    HIGH_ALERTS=$((HIGH_ALERTS + HIGH))
    MEDIUM_ALERTS=$((MEDIUM_ALERTS + MEDIUM))
    LOW_ALERTS=$((LOW_ALERTS + LOW))
    TOTAL_ALERTS=$((TOTAL_ALERTS + CRITICAL + HIGH + MEDIUM + LOW))

    # Check for SLA breaches
    for ALERT in $(echo "$ALERTS" | jq -c '.[]'); do
        SEVERITY=$(echo "$ALERT" | jq -r '.security_advisory.severity')
        CREATED_AT=$(echo "$ALERT" | jq -r '.created_at')

        # Calculate age in hours
        ALERT_AGE_HOURS=$(( ($(date +%s) - $(date -d "$CREATED_AT" +%s)) / 3600 ))

        # Determine SLA window
        case "$SEVERITY" in
            critical) SLA_HOURS=24 ;;
            high) SLA_HOURS=168 ;;
            medium) SLA_HOURS=720 ;;
            low) SLA_HOURS=2160 ;;
            *) SLA_HOURS=2160 ;;
        esac

        # Check for breach
        if [[ $ALERT_AGE_HOURS -gt $SLA_HOURS ]]; then
            SLA_BREACHES=$((SLA_BREACHES + 1))
            echo "    âš ï¸ SLA BREACH: $SEVERITY alert open for $ALERT_AGE_HOURS hours (SLA: $SLA_HOURS hours)"
        fi
    done

    # Get closed alerts (patched) from last 30 days
    CLOSED_ALERTS=$(gh api "repos/$REPO/dependabot/alerts?state=closed" --jq '[.[] | select(.dismissed_at == null)] | length' 2>/dev/null || echo "0")
    PATCHED_WITHIN_SLA=$((PATCHED_WITHIN_SLA + CLOSED_ALERTS))
done

echo ""
echo "2. Calculating SLA compliance metrics..."

# Calculate compliance rate
if [[ $TOTAL_ALERTS -gt 0 ]] || [[ $PATCHED_WITHIN_SLA -gt 0 ]]; then
    TOTAL_PROCESSED=$((TOTAL_ALERTS + PATCHED_WITHIN_SLA))
    COMPLIANT=$((TOTAL_PROCESSED - SLA_BREACHES))
    COMPLIANCE_RATE=$(awk "BEGIN {printf \"%.2f\", ($COMPLIANT / $TOTAL_PROCESSED) * 100}")
else
    COMPLIANCE_RATE="100.00"
fi

echo "  Total open alerts: $TOTAL_ALERTS"
echo "    Critical: $CRITICAL_ALERTS"
echo "    High: $HIGH_ALERTS"
echo "    Medium: $MEDIUM_ALERTS"
echo "    Low: $LOW_ALERTS"
echo "  Patched within SLA (last 30 days): $PATCHED_WITHIN_SLA"
echo "  SLA breaches: $SLA_BREACHES"
echo "  SLA compliance rate: $COMPLIANCE_RATE%"
echo ""

# Generate JSON report
cat > "$AUDIT_REPORT" << JSON
{
  "audit_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
  "audit_period": "last_30_days",
  "auditor": "Jorge (VP AI-SecOps)",
  "repositories": [
    $(printf '"%s"' "${REPOS[@]}" | paste -sd, -)
  ],
  "open_alerts": {
    "total": $TOTAL_ALERTS,
    "critical": $CRITICAL_ALERTS,
    "high": $HIGH_ALERTS,
    "medium": $MEDIUM_ALERTS,
    "low": $LOW_ALERTS
  },
  "patched_alerts": {
    "total": $PATCHED_WITHIN_SLA,
    "within_sla": $((PATCHED_WITHIN_SLA - SLA_BREACHES))
  },
  "sla_compliance": {
    "breaches": $SLA_BREACHES,
    "compliance_rate": $COMPLIANCE_RATE,
    "target_rate": "100.00"
  },
  "sla_windows": {
    "critical": {
      "hours": 24,
      "days": 1
    },
    "high": {
      "hours": 168,
      "days": 7
    },
    "medium": {
      "hours": 720,
      "days": 30
    },
    "low": {
      "hours": 2160,
      "days": 90
    }
  },
  "soc2_compliance": true,
  "recommendations": [
    $(if [[ $SLA_BREACHES -gt 0 ]]; then echo '"Investigate and patch $SLA_BREACHES SLA breaches immediately"'; else echo '"No breaches detected - maintain current patching cadence"'; fi),
    "Continue monthly audits for SOC 2 compliance",
    "Review auto-merge success rate and adjust thresholds if needed"
  ]
}
JSON

echo "3. Audit report generated: $AUDIT_REPORT"
echo ""

# Check if target met
if [[ $SLA_BREACHES -eq 0 ]]; then
    echo "âœ“ SLA COMPLIANCE: Target met (100% compliance)"
else
    echo "âœ— SLA BREACH: $SLA_BREACHES open alerts exceed SLA window"
    echo "  Action required: Patch breached vulnerabilities immediately"
fi

echo ""
echo "Report saved: $AUDIT_REPORT"
EOF

chmod +x "$PROJECT_ROOT/scripts/monthly-vulnerability-sla-audit.sh"
echo "âœ“ Monthly audit script created: scripts/monthly-vulnerability-sla-audit.sh"
echo ""

# Create documentation
echo "5. Creating SLA documentation..."
mkdir -p "$PROJECT_ROOT/docs/security"

cat > "$PROJECT_ROOT/docs/security/vulnerability-patch-slas.md" << 'EOF'
# Vulnerability Patch SLAs

## Overview
Seven Fortunas maintains strict Service Level Agreements (SLAs) for patching security vulnerabilities to ensure infrastructure security and SOC 2 compliance.

## SLA Policy

| Severity | Patch Window | Auto-Merge | Alert Channels |
|----------|-------------|------------|----------------|
| **Critical** | 24 hours | No (manual review) | Email, Matrix, GitHub Issue |
| **High** | 7 days | Yes (if tests pass) | Email, Matrix |
| **Medium** | 30 days | Yes | GitHub Issue |
| **Low** | 90 days | Yes | None |

## Automated Patching Workflow

### Dependabot Configuration
Dependabot automatically creates pull requests for vulnerability patches.

**Configuration:** `.github/dependabot.yml`

### Auto-Merge Workflow
GitHub Actions workflow automatically merges eligible patches based on severity.

**Workflow:** `.github/workflows/dependabot-auto-merge.yml`

**Auto-Merge Criteria:**
1. PR created by Dependabot
2. Severity is High, Medium, or Low (Critical requires manual review)
3. All CI checks pass
4. Within SLA window

### SLA Breach Warnings
Automated alerts when approaching SLA breach (80% of window elapsed):
- GitHub PR comment
- Email notification (for Critical/High)
- Matrix message (for Critical/High)

## Manual Review Process

### Critical Vulnerabilities (24-hour SLA)
1. Dependabot creates PR with "ðŸš¨ CRITICAL" label
2. GitHub Actions adds SLA warning comment
3. Security team (Jorge) reviews PR within 24 hours
4. Manual testing if needed
5. Merge and deploy

**Approval Required:** Yes (cannot auto-merge)

### High Vulnerabilities (7-day SLA)
1. Dependabot creates PR
2. Auto-merge if CI passes
3. Manual review if CI fails or complex changes

**Approval Required:** No (auto-merge enabled)

## Monthly Audit

### Purpose
Validate SLA compliance for SOC 2 and internal security policies.

### Process
```bash
# Run monthly audit
./scripts/monthly-vulnerability-sla-audit.sh
```

**Output:** `compliance/sla/audit-reports/vulnerability-sla-audit-TIMESTAMP.json`

### Audit Report Contents
- Open alerts by severity
- Patched alerts (last 30 days)
- SLA breaches count
- Compliance rate (%)
- Recommendations

### Compliance Target
**Target:** 100% SLA compliance (zero breaches)
**Acceptable:** â‰¥95% compliance (max 5% breaches with documented justification)

## SLA Metrics

### Tracked Metrics
1. **SLA Compliance Rate:** % of vulnerabilities patched within SLA
2. **Average Patch Time by Severity:** Mean time to patch by severity level
3. **SLA Breaches Count:** Number of vulnerabilities exceeding SLA window
4. **Auto-Merge Success Rate:** % of auto-merge PRs that succeeded
5. **Manual Intervention Rate:** % of patches requiring manual review

### Dashboard Integration
SLA metrics feed into:
- Security Dashboard (real-time monitoring)
- SOC 2 Compliance Dashboard (quarterly reports)
- Project Progress Dashboard (team visibility)

## Handling SLA Breaches

### When a Breach Occurs
1. **Immediate Action:** Patch the vulnerability as soon as possible
2. **Root Cause Analysis:** Document why breach occurred
3. **Process Improvement:** Update workflow to prevent future breaches
4. **SOC 2 Documentation:** Record breach in compliance log with remediation plan

### Common Breach Causes
- Dependency conflicts requiring manual resolution
- Complex breaking changes requiring code refactoring
- Test failures blocking auto-merge
- Holiday/weekend timing for Critical vulnerabilities

### Mitigation Strategies
- Monitor Dependabot alerts daily
- Enable Slack/Matrix notifications for Critical alerts
- Assign on-call rotation for Critical vulnerabilities
- Pre-approve low-risk patches for faster merging

## SOC 2 Integration

### Control: CC6.7 - Security Vulnerability Management
**Requirement:** Organization identifies, prioritizes, and remediates security vulnerabilities in a timely manner.

**Evidence:**
- SLA policy documentation (this document)
- Monthly audit reports (JSON files in `compliance/sla/audit-reports/`)
- GitHub Actions workflow logs (auto-merge activity)
- Dependabot alert history

### Audit Preparation
```bash
# Generate last 12 months of audit reports for SOC 2 audit
for i in {1..12}; do
    ./scripts/monthly-vulnerability-sla-audit.sh
    sleep 1  # Unique timestamp
done
```

## Troubleshooting

### Dependabot PR Not Auto-Merging
1. Check CI status: `gh pr checks PR_NUMBER`
2. Verify severity: `gh pr view PR_NUMBER --json labels`
3. Review workflow logs: GitHub Actions > Dependabot Auto-Merge
4. Manual merge if needed: `gh pr merge PR_NUMBER --squash`

### SLA Breach Alert Not Sent
1. Check GitHub Actions workflow permissions (write access required)
2. Verify email/Matrix integration configured
3. Review workflow logs for errors

### Audit Script Fails
1. Ensure GitHub CLI authenticated: `gh auth status`
2. Verify repository access: `gh repo view OWNER/REPO`
3. Check jq installed: `jq --version`

## References

- [Dependabot Documentation](https://docs.github.com/en/code-security/dependabot)
- [GitHub Actions Auto-Merge](https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/incorporating-changes-from-a-pull-request/automatically-merging-a-pull-request)
- [SOC 2 CC6.7 Control](https://www.aicpa.org/interestareas/frc/assuranceadvisoryservices/aicpasoc2report)
- Seven Fortunas Dependency Management (FEATURE_020)

---

**Last Updated:** 2026-02-17
**Owner:** Jorge (VP AI-SecOps)
**Review Cycle:** Monthly (with audit)
EOF

echo "âœ“ Documentation created: docs/security/vulnerability-patch-slas.md"
echo ""

echo "=== Setup Complete ==="
echo ""
echo "SLA Policy:"
echo "- Critical: 24 hours (manual review)"
echo "- High: 7 days (auto-merge)"
echo "- Medium: 30 days (auto-merge)"
echo "- Low: 90 days (auto-merge)"
echo ""
echo "Automation:"
echo "- Dependabot auto-merge workflow: .github/workflows/dependabot-auto-merge.yml"
echo "- Monthly audit script: scripts/monthly-vulnerability-sla-audit.sh"
echo "- SLA configuration: compliance/sla/vulnerability-patch-slas.yaml"
echo ""
echo "Next Steps:"
echo "1. Deploy workflow to repositories (copy .github/workflows/dependabot-auto-merge.yml)"
echo "2. Enable Dependabot alerts (if not already enabled)"
echo "3. Configure Matrix/email notifications"
echo "4. Schedule monthly audit (cron or GitHub Actions)"
echo ""
