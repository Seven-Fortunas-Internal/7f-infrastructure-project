#!/bin/bash
# check-vulnerability-sla-compliance.sh - Check vulnerability patch SLA compliance

set -euo pipefail

# Configuration
GITHUB_ORG="${GITHUB_ORG:-Seven-Fortunas-Internal}"
REPO="${REPO:-7f-infrastructure-project}"
OUTPUT_FILE="sla-compliance-$(date +%Y-%m).json"

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

# SLA windows (in days)
CRITICAL_SLA=1
HIGH_SLA=7
MEDIUM_SLA=30
LOW_SLA=90

# Counters
declare -A TOTAL PATCHED BREACHED

for severity in critical high medium low; do
    TOTAL[$severity]=0
    PATCHED[$severity]=0
    BREACHED[$severity]=0
done

echo "Seven Fortunas - Vulnerability Patch SLA Compliance Check"
echo "==========================================================="
echo ""
echo "Organization: $GITHUB_ORG"
echo "Repository: $REPO"
echo "Report Period: $(date +%Y-%m)"
echo ""

# Check if gh is authenticated
if ! gh auth status &> /dev/null; then
    echo -e "${RED}Error:${NC} GitHub CLI not authenticated"
    echo "Run: gh auth login"
    exit 1
fi

# Fetch Dependabot alerts
echo "Fetching Dependabot alerts..."
ALERTS=$(gh api "repos/$GITHUB_ORG/$REPO/dependabot/alerts" --paginate 2>/dev/null || echo "[]")

if [[ "$ALERTS" == "[]" ]]; then
    echo -e "${YELLOW}Note:${NC} No Dependabot alerts found (or API access denied)"
    echo "This could mean:"
    echo "  - Repository has no vulnerabilities (good!)"
    echo "  - Dependabot not enabled"
    echo "  - GitHub Advanced Security not enabled"
    echo ""
fi

# Process each alert
echo "$ALERTS" | jq -r '.[] | @json' | while read -r alert; do
    STATE=$(echo "$alert" | jq -r '.state')
    SEVERITY=$(echo "$alert" | jq -r '.security_advisory.severity' | tr '[:upper:]' '[:lower:]')
    CREATED=$(echo "$alert" | jq -r '.created_at')
    FIXED=$(echo "$alert" | jq -r '.fixed_at // empty')

    # Skip if not a valid severity
    [[ ! "$SEVERITY" =~ ^(critical|high|medium|low)$ ]] && continue

    ((TOTAL[$SEVERITY]++))

    if [[ "$STATE" == "fixed" && -n "$FIXED" ]]; then
        # Calculate patch time
        CREATED_TS=$(date -d "$CREATED" +%s)
        FIXED_TS=$(date -d "$FIXED" +%s)
        PATCH_TIME_DAYS=$(( ($FIXED_TS - $CREATED_TS) / 86400 ))

        # Check SLA
        case $SEVERITY in
            critical) SLA=$CRITICAL_SLA ;;
            high) SLA=$HIGH_SLA ;;
            medium) SLA=$MEDIUM_SLA ;;
            low) SLA=$LOW_SLA ;;
        esac

        if [[ $PATCH_TIME_DAYS -le $SLA ]]; then
            ((PATCHED[$SEVERITY]++))
        else
            ((BREACHED[$SEVERITY]++))
        fi
    fi
done

# Calculate compliance rates
for severity in critical high medium low; do
    total=${TOTAL[$severity]}
    patched=${PATCHED[$severity]}
    breached=${BREACHED[$severity]}

    if [[ $total -gt 0 ]]; then
        compliance=$(awk "BEGIN {printf \"%.1f\", ($patched / $total) * 100}")
    else
        compliance="N/A"
    fi

    echo ""
    echo "$(echo $severity | tr '[:lower:]' '[:upper:]'):"
    echo "  Total: $total"
    echo "  Patched within SLA: $patched"
    echo "  SLA Breaches: $breached"
    echo "  Compliance Rate: $compliance%"

    # Color code
    if [[ "$compliance" != "N/A" ]] && (( $(echo "$compliance >= 95" | bc -l) )); then
        echo -e "  Status: ${GREEN}PASS${NC}"
    elif [[ "$compliance" != "N/A" ]]; then
        echo -e "  Status: ${RED}FAIL${NC}"
    else
        echo -e "  Status: ${YELLOW}N/A${NC}"
    fi
done

# Generate JSON report
cat > "$OUTPUT_FILE" <<EOFJSON
{
  "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
  "organization": "$GITHUB_ORG",
  "repository": "$REPO",
  "report_period": "$(date +%Y-%m)",
  "sla_targets": {
    "critical": "$CRITICAL_SLA days",
    "high": "$HIGH_SLA days",
    "medium": "$MEDIUM_SLA days",
    "low": "$LOW_SLA days"
  },
  "compliance": {
    "critical": {
      "total": ${TOTAL[critical]},
      "patched": ${PATCHED[critical]},
      "breached": ${BREACHED[critical]}
    },
    "high": {
      "total": ${TOTAL[high]},
      "patched": ${PATCHED[high]},
      "breached": ${BREACHED[high]}
    },
    "medium": {
      "total": ${TOTAL[medium]},
      "patched": ${PATCHED[medium]},
      "breached": ${BREACHED[medium]}
    },
    "low": {
      "total": ${TOTAL[low]},
      "patched": ${PATCHED[low]},
      "breached": ${BREACHED[low]}
    }
  }
}
EOFJSON

echo ""
echo "==========================================================="
echo "Report saved to: $OUTPUT_FILE"
echo ""

exit 0
